Original prompt: PLEASE IMPLEMENT THIS PLAN: Ocean Outlaws Narrative Voyage Plan (Current-Architecture Fit), including story-state persistence, event engine + modal, 3D set dressing via existing GLBs, story audio expansion, music mode improvements, debug payload updates, and harbor storyline integration while preserving current architecture.

## 2026-02-26
- Resumed an in-progress implementation with new story modules and partial `main.js` integration already in workspace.
- Next: run parse/JSON checks, fix breakages, then run Playwright smoke loop and verify screenshots + render_game_to_text.
- Ran `node --check` on all modified/new JS modules and verified `game/data/assetRoleRegistry.json` parses cleanly.
- Added `progress.md` tracking file and started iterative Playwright runs using the `develop-web-game` client.
- Fixed local/dev URL portability by changing `game/index.html` base from `/ocean-outlaws/game/` to `./` so the game runs under local static serving and GitHub Pages-style paths.
- Captured Playwright artifacts:
  - baseline render OK (`output/web-game/baseline3`),
  - voyage chart flow (`output/web-game/start2`),
  - event modal visible (`output/web-game/event2`),
  - combat/card flow (`output/web-game/event1`).
- Added harbor storyline integration in `main.js`:
  - first port call per region now writes journal lore, nudges faction rep, sets a region harbor flag, plays cues, and shows a harbor story banner.
- Hardened story audio loading (`storyAudio.js`) to avoid caching null buffers before audio unlock.
- Fixed service-worker cache manifest to remove stale non-existent JS entries that would break cache install.
- Re-ran validation:
  - `node --check` passes for updated modules.
  - `assetRoleRegistry.json` parses.
  - service worker ASSET list now resolves to existing files only (`missing 0`).
- Playwright post-fix checks:
  - baseline state render clean (`output/web-game/postfix-baseline`).
  - event modal confirmed after changes (`output/web-game/postfix-event-modal-attempt6`).
  - harbor storyline beat confirmed live (`output/web-game/postfix-port-hunt-8`):
    - screenshot shows `PORT OF CALL` with harbor rumor banner.
    - state shows `flagsCount: 1`, `journalCount: 1`, rep deltas `{ navy: 2, merchant: 5 }`.
- Remaining limitation: because voyage chart generation is seeded per run, node-click smoke tests are probabilistic and required repeated attempts.
- UX follow-up: moved harbor announcement visibility into the port screen itself (`portScreen.js` `storyNotice`) because HUD banners are layered below the port overlay.
- `main.js` now passes `storyNotice` into `showPortScreen(...)` from `markHarborStoryBeat(...)`; harbor beats still apply rep/flags/journal and now surface reliably in the visible port UI.
- Integrated `origin/main` via fast-forward, then reapplied local story WIP cleanly.
- Began city-on-coast implementation by extending `port.js` (reusing existing port system and coastline placement):
  - ports can now promote into coastal cities anchored on land-side positions validated by `isHeightmapLand`.
  - hostile cities spawn battery turrets that fire projectiles at the player.
  - player projectiles can destroy batteries; pacifying all batteries flips city to friendly port state and awards gold.
  - city metadata now flows through `getPortsInfo` (labels/hostile state/city identity).
- Wired runtime integration:
  - `main.js` now forwards `scene` + `weapons` into `updatePorts`.
  - rolling-origin shift now also rebases city projectile origins.
  - city event queue from `port.js` is drained in `main.js` for banners + story journal updates on pacification.
- HUD updates:
  - nearest port label now distinguishes `PORT`, `CITY PORT`, and `HOSTILE CITY`, with hostile warning distance extended.
- Added debug visibility in `render_game_to_text`: `portCities` payload (`cities`, `hostileCities`, `hostileBatteries`).
- Coastal city alignment pass in `port.js`:
  - city anchors now score for landmass support + coastal exposure instead of taking first valid hit.
  - city set-dressing root now uses sampled land height (`localY`) so cities sit on terrain instead of waterline.
  - city battery anchors now snap to nearby valid land points and use sampled terrain height.
- Spawn distribution safeguards:
  - if eligible coastal anchors exist, ensure at least one city port.
  - if cities exist, ensure at least one hostile city.
  - cap city share by map (`PORT_CITY_MAX_FRACTION`) to preserve plain-port pacing.
- Bug fix discovered via Playwright:
  - `terrainBlocksLine` was referenced by city battery LOS logic but missing from imports in `port.js`; added import to fix runtime `ReferenceError`.
- Validation after fixes:
  - `node --check` passes for `game/js/port.js`, `game/js/main.js`, `game/js/hud.js`.
  - Playwright smoke artifacts:
    - `output/web-game/city-probe-1`: harbor rumor notice visible in port UI.
    - `output/web-game/city-probe-5/state-0.json`: combat state with `ports:3`, `portCities.cities:1`, `hostileCities:1`, `hostileBatteries:4` (hostile gun city confirmed live).
- Investigated and fixed reported gameplay bugs:
  - Added hostile city battery targeting into nav targeting path (click-select + combat reticle updates) and auto-target fallback in combat loop.
  - Hardened combat target validity checks so targets clear when mesh is removed (prevents stale reticle/target across mission transitions).
  - Added explicit `clearCombatTarget()` calls across run/zone/mode reset paths and wave transitions.
  - Improved city battery projectile readability (larger brighter projectile mesh) and reduced false no-fire cases by allowing close-range fire even if shoreline LOS is noisy.
  - Removed ship-like decorative story setpieces that looked like inert enemy spawns; replaced with non-ship props in fallback set dressing + story role registry.
- Validation:
  - `node --check` passes for `game/js/nav.js`, `game/js/main.js`, `game/js/port.js`, `game/js/storySetDressing.js`.
  - `assetRoleRegistry.json` parses cleanly.
- Added `target` snapshot to `window.render_game_to_text()` payload to make targeting behavior verifiable in automated checks (`enemy`/`boss`/`city_battery`).
- Playwright smoke loops executed after fixes:
  - `output/web-game/bugfix-smoke-1`: reached combat/card state; confirms no ship-like inert setpiece in view and hostile city presence in state (`hostileBatteries>0`).
  - `output/web-game/bugfix-smoke-3`: live combat with hostile city + active target snapshot (`target.kind: "enemy"`) validating new target debug payload and no console errors.
  - `output/web-game/bugfix-smoke-4`: frozen card state with `hostileCities` and `hostileBatteries` populated, ensuring city battery systems still active post-fix.
  - `output/web-game/bugfix-smoke-5`: returned to voyage chart cleanly (no stuck target state carried into non-combat mode).
- Remaining validation gap: deterministic automation did not capture a final frame with `target.kind: "city_battery"` due run-state randomness and card timing, but code-path coverage is in place (click-target + auto-target + reticle sync + stale-target clearing).
- Follow-up user issue fixes:
  - Enemy harbors now show distinctly on minimap via typed port markers (`port_hostile` red crossed marker, `port_city` blue diamond, normal `port` gold square).
  - Main minimap port payload now includes marker type and uses city anchors for hostile cities so enemy harbor position is clear.
  - Added hostile battery HP bars in combat (`health.js`) sourced from world-space battery coordinates.
  - Added explicit reward surfacing for city combat: battery destroy and city pacify events now carry `rewardGold`, display in banner + kill feed + floating gold number, and increment `runGoldLooted`.
  - Battery objects now carry `maxHp` for stable HP bar ratios.
- Validation:
  - `node --check` passes for `main.js`, `minimap.js`, `health.js`, `port.js`.
  - Playwright smoke (`output/web-game/bugfix-map-health-reward`) shows hostile city activity in state (`hostileCities:2`, `hostileBatteries:8`) and minimap hostile markers rendered in captured frame.
- Land/pathing follow-up fixes:
  - `ship.js`: added land-aware nav bypass waypoints for player autopilot when direct line to nav target is blocked by land colliders; includes replan cooldown and bypass completion handling.
  - `enemy.js`: added land-aware bypass waypoint planning for enemies (trade-route, chase, and flee goals) with low-frequency replans to reduce island collision loops.
  - Both still retain existing terrain avoidance + slide collision + stuck nudge as fallback layers.
- Port overlap hardening:
  - `port.js`: coastline placement now validates root/dock against full `isLand` collider checks (not just heightmap), with fallback water anchor search before accepting candidate.
  - Increased dock clearance radius to better match real dock footprint and prevent overlap with nearby land masses.
- Validation:
  - `node --check` passes for `ship.js`, `enemy.js`, `port.js`, and `main.js`.
  - Playwright smoke run completed (`output/web-game/pathing-portfix-smoke`) with no runtime error artifacts.
- Phase 2 kickoff (`codex/phase2-water-pathing`):
  - Added shared planner module `game/js/waterPath.js` with bounded local-grid A* over water cells, start/goal water snapping, diagonal corner-cut prevention, and LOS-based waypoint simplification.
  - Player nav integration in `ship.js`:
    - introduced `_navPath` waypoint queue + `_navPathIndex`.
    - direct path uses existing behavior; when land blocks LOS, ship now attempts A* plan first and falls back to legacy bypass waypoint if planning fails.
    - nav state reset now clears path queue in both `setNavTarget` and `clearNavTarget`.
  - Enemy nav integration in `enemy.js`:
    - introduced `_navPath` waypoint queue on enemy state.
    - when chase/flee/trade-route goals are terrain-blocked, enemies attempt shared A* path first, then fallback to previous bypass waypoint heuristic.
  - Rolling-origin consistency in `main.js`:
    - active ship/enemy path waypoints and bypass points are now shifted with world origin rebases.
  - Nav hold-stop cleanup in `nav.js`:
    - `stopHold()` now calls `clearNavTarget(...)` so path/bypass state is fully cleared.
  - Fixed planner clearance bug:
    - `isWaterWithClearance(...)` now correctly rejects cells that are land or too close to land.
- Validation for Phase 2 slice:
  - `node --check` passes: `game/js/waterPath.js`, `game/js/ship.js`, `game/js/enemy.js`, `game/js/main.js`, `game/js/nav.js`.
  - Playwright runs executed:
    - `output/web-game/phase2-path-smoke-1`
    - `output/web-game/phase2-path-smoke-2`
    - `output/web-game/phase2-path-smoke-3`
    - `output/web-game/phase2-path-smoke-4`
    - `output/web-game/phase2-path-smoke-5`
    - `output/web-game/phase2-path-smoke-6`
    - `output/web-game/phase2-path-smoke-7`
    - `output/web-game/phase2-path-smoke-8`
  - No runtime error artifacts emitted in these runs (`errors-*.json` absent).
  - Limitation: current skill client drives canvas-relative inputs; several flows remained on menu/voyage UI overlays (DOM layers intercepting), so automated captures did not deterministically reach live combat pathing despite repeated bursts.
- Next TODOs for Phase 2:
  - Add deterministic Playwright setup path for this project (selector-driven New Run + ship select + chart node pick) so pathing can be visually validated in combat every run.
  - Add lightweight debug counters in `render_game_to_text` for nav planner (`activePathWaypoints`, `pathReplans`) to confirm A* engagement vs fallback during automated tests.
